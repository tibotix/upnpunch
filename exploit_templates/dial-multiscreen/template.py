from .. import base_template
import ssdp



class DialMultiscreenHTTPHandler(base_template.BaseHTTPHandler):
    def device_desc(self):
        app_url = "http://{0}:{1}/applicationurl/".format(self.local_ip, str(self.local_port))
        self.send_response(200)
        self.send_header("Content-type", "text/xml; charset=UTF-8")
        self.send_header("Application-URL", "{}".format(app_url))
        self.end_headers()
        self.send_file("exploit_templates/dial-multiscreen/device-desc.xml", local_ip=self.local_ip, local_port=str(self.local_port), session_usn=self.server.session_usn)
DialMultiscreenHTTPHandler.GET_routes = {"/device-desc.xml": DialMultiscreenHTTPHandler.device_desc}



class DialMultiscreenUPNPRequestHandler(base_template.BaseUPNPRequestHandler):
    allowed_methods = ["M-SEARCH"]
    needed_headers = ["ST"]

    def _handle(self):
        if("dial-multiscreen-org" in self.request_headers["ST"]):
            return self.build_resp()

    def build_resp(self):
        headers={
            "CACHE-CONTROL": "max-age=1800",
            "LOCATION": "http://{}:{}/device-desc.xml".format(str(self.template_ip), str(self.template_port)),
            "Server": "Python UPnP/1.0 SSDP",
            "ST": "{}".format(str(self.request_headers["ST"])),
            "EXT": "",
            "USN": "uuid:{}::{}".format(str(self.session_usn), str(self.request_headers["ST"])),
        }
        return ssdp.SSDPResponse(200, "OK", headers=headers)


class Template(base_template.BaseTemplate):
    HTTPHandler = DialMultiscreenHTTPHandler
    UPNPRequestHandler = DialMultiscreenUPNPRequestHandler
    HTTP_PORT = 8787
    SESSION_USN = base_template.BaseTemplate.random_usn()
