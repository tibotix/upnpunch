from .. import base_template
import ssdp


class IGDHTTPHandler(base_template.BaseHTTPHandler):
    def device_desc(self):
        self.send_response(200)
        self.send_header("Content-type", "application/xml")
        self.end_headers()
        self.send_file("exploit_templates/igd/device-desc.xml", local_ip=self.local_ip, local_port=str(self.local_port), session_usn=self.server.session_usn)
IGDHTTPHandler.GET_routes = {"/device-desc.xml": IGDHTTPHandler.device_desc}



class IGDUPNPRequestHandler(base_template.BaseUPNPRequestHandler):
    allowed_methods = ["M-SEARCH"]
    needed_headers = ["ST"]

    def _handle(self):
        if("InternetGatewayDevice:1" in self.request_headers["ST"]):
            return self.build_resp()

    def build_resp(self):
        headers={
            "CACHE-CONTROL": "max-age=1800",
            "LOCATION": "http://{}:{}/device-desc.xml".format(str(self.template_ip), str(self.template_port)),
            "Server": "Python UPnP/1.0 SSDP",
            "ST": "{}".format(str(self.request_headers["ST"])),
            "EXT": "",
            "USN": "uuid:{}::{}".format(str(self.session_usn), str(self.request_headers["ST"]))
        }
        return ssdp.SSDPResponse(200, "OK", headers=headers)


class Template(base_template.BaseTemplate):
    HTTPHandler = IGDHTTPHandler
    UPNPRequestHandler = IGDUPNPRequestHandler
    HTTP_PORT = 8788
    SESSION_USN = base_template.BaseTemplate.random_usn()
